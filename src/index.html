<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ê–û "–ó–∞–≤–æ–¥ –¢–ê–ì–ê–¢" - –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –ì–¢–î</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #2c3e50;
        --secondary: #34495e;
        --accent: #e74c3c;
        --success: #27ae60;
        --warning: #f39c12;
        --danger: #c0392b;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .main-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        margin: 20px auto;
        min-height: 90vh;
      }

      .header {
        background: var(--primary);
        color: white;
        border-radius: 20px 20px 0 0;
        padding: 20px 30px;
        margin: -12px;
      }

      .logo {
        font-weight: 700;
        font-size: 1.5rem;
      }

      .system-name {
        font-size: 1.8rem;
        font-weight: 300;
      }

      .input-panel {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin: 20px;
        border-left: 5px solid var(--accent);
      }

      .image-container {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s;
        background: #fafafa;
        overflow: hidden;
      }

      .image-container:hover {
        border-color: var(--accent);
        background: #f0f8ff;
      }

      .result-image {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .defect-table {
        font-size: 0.9rem;
      }

      .defect-critical {
        border-left: 4px solid var(--danger);
      }
      .defect-high {
        border-left: 4px solid var(--warning);
      }
      .defect-medium {
        border-left: 4px solid var(--success);
      }

      .confidence-bar {
        height: 8px;
        background: #ecf0f1;
        border-radius: 4px;
        overflow: hidden;
      }

      .confidence-fill {
        height: 100%;
        border-radius: 4px;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
      }

      .btn-tagat {
        background: linear-gradient(135deg, var(--accent) 0%, #c0392b 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
      }

      .mode-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .mode-btn {
        flex: 1;
        padding: 10px;
        border: 2px solid #dee2e6;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .mode-btn.active {
        border-color: var(--accent);
        background: var(--accent);
        color: white;
      }

      .mode-btn:hover:not(.active) {
        border-color: var(--accent);
      }

      .video-preview {
        max-width: 100%;
        border-radius: 10px;
        background: #000;
      }

      .video-controls {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .hidden {
        display: none !important;
      }

      .preview-container {
        position: relative;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <div class="container main-container">
      <!-- –®–∞–ø–∫–∞ -->
      <div class="header">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="logo">–ê–û "–ó–ê–í–û–î –¢–ê–ì–ê–¢"</div>
            <div class="system-name">–°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –ì–¢–î</div>
          </div>
          <div class="col-md-6 text-end">
            <div id="currentDateTime"></div>
            <div>–û–ø–µ—Ä–∞—Ç–æ—Ä: <strong>–ò–≤–∞–Ω–æ–≤ –ê.–í.</strong></div>
          </div>
        </div>
      </div>

      <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
      <div class="container-fluid mt-4">
        <div class="row">
          <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö -->
          <div class="col-lg-4">
            <div class="input-panel">
              <h5 class="mb-4">üìÅ –ò–°–¢–û–ß–ù–ò–ö –î–ê–ù–ù–´–•</h5>

              <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ -->
              <div class="mode-selector">
                <button id="photoModeBtn" class="mode-btn active">
                  <i class="fas fa-camera me-2"></i>–†–µ–∂–∏–º: –§–æ—Ç–æ
                </button>
                <button id="videoModeBtn" class="mode-btn">
                  <i class="fas fa-video me-2"></i>–†–µ–∂–∏–º: –í–∏–¥–µ–æ
                </button>
              </div>

              <div class="mb-3">
                <label class="form-label">‚Ññ –î–≤–∏–≥–∞—Ç–µ–ª—è</label>
                <select class="form-select" id="engineNumber">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∏–≥–∞—Ç–µ–ª—å</option>
                  <option value="–¢–ê–ì–ê–¢-2024-001">–¢–ê–ì–ê–¢-2024-001</option>
                  <option value="–¢–ê–ì–ê–¢-2024-002">–¢–ê–ì–ê–¢-2024-002</option>
                  <option value="–¢–ê–ì–ê–¢-2024-003">–¢–ê–ì–ê–¢-2024-003</option>
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">‚Ññ –õ–æ–ø–∞—Ç–∫–∏</label>
                <input
                  type="text"
                  class="form-control"
                  id="bladeNumber"
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: LP-045"
                />
              </div>

              <div class="mb-3">
                <label class="form-label">–î–∞—Ç–∞ –æ—Å–º–æ—Ç—Ä–∞</label>
                <input type="date" class="form-control" id="inspectionDate" />
              </div>

              <div class="mb-4">
                <label class="form-label">–û–ø–µ—Ä–∞—Ç–æ—Ä</label>
                <input
                  type="text"
                  class="form-control"
                  id="operator"
                  value="–ò–≤–∞–Ω–æ–≤ –ê.–í."
                  readonly
                />
              </div>

              <!-- –ë–ª–æ–∫ –¥–ª—è —Ñ–æ—Ç–æ -->
              <div id="photoUploadBlock">
                <div class="image-container mb-3">
                  <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                  <p class="text-muted">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏</p>
                  <input
                    type="file"
                    id="imageUpload"
                    accept="image/*"
                    class="d-none"
                  />
                  <button
                    class="btn btn-outline-primary"
                    onclick="document.getElementById('imageUpload').click()"
                  >
                    üìé –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                  </button>
                  <div id="fileName" class="mt-2 small text-muted"></div>
                </div>
              </div>

              <!-- –ë–ª–æ–∫ –¥–ª—è –≤–∏–¥–µ–æ -->
              <div id="videoUploadBlock" class="hidden">
                <div class="image-container mb-3">
                  <i class="fas fa-video fa-3x text-muted mb-3"></i>
                  <p class="text-muted">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ —ç–Ω–¥–æ—Å–∫–æ–ø</p>
                  <div class="video-controls">
                    <button class="btn btn-outline-primary" id="startVideoBtn">
                      <i class="fas fa-play me-2"></i>–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ
                    </button>
                    <button
                      class="btn btn-outline-danger hidden"
                      id="stopVideoBtn"
                    >
                      <i class="fas fa-stop me-2"></i>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>
                  </div>
                  <div class="mt-3">
                    <p class="text-muted small">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª</p>
                    <input
                      type="file"
                      id="videoFileUpload"
                      accept="video/*"
                      class="d-none"
                    />
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      onclick="document.getElementById('videoFileUpload').click()"
                    >
                      <i class="fas fa-upload me-1"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ
                    </button>
                  </div>
                </div>
              </div>

              <button class="btn btn-tagat w-100" id="analyzeBtn">
                <span
                  class="spinner-border spinner-border-sm me-2 d-none"
                  id="spinner"
                ></span>
                <span id="analyzeBtnText">üöÄ –ó–ê–ì–†–£–ó–ò–¢–¨ –ò –ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨</span>
              </button>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="row mt-4" id="statsSection" style="display: none">
              <div class="col-6 mb-3">
                <div class="stat-card">
                  <div class="h4 mb-1" id="totalDefects">0</div>
                  <small>–í—Å–µ–≥–æ –¥–µ—Ñ–µ–∫—Ç–æ–≤</small>
                </div>
              </div>
              <div class="col-6 mb-3">
                <div class="stat-card">
                  <div class="h4 mb-1" id="criticalDefects">0</div>
                  <small>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ</small>
                </div>
              </div>
            </div>
          </div>

          <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
          <div class="col-lg-8">
            <!-- –û–±–ª–∞—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ -->
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h6 class="mb-0">üëÅÔ∏è –û–ë–õ–ê–°–¢–¨ –ü–†–û–°–ú–û–¢–†–ê –ò –ê–ù–ê–õ–ò–ó–ê</h6>
              </div>
              <div class="card-body">
                <div class="preview-container">
                  <!-- –î–ª—è —Ñ–æ—Ç–æ -->
                  <img
                    id="staticImagePreview"
                    class="result-image hidden"
                    src=""
                    alt="–ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
                  />

                  <!-- –î–ª—è –≤–∏–¥–µ–æ -->
                  <video
                    id="liveVideoPreview"
                    class="video-preview hidden"
                    autoplay
                    muted
                    playsinline
                  ></video>

                  <!-- –î–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ—Ñ–∞–π–ª–∞ -->
                  <video
                    id="fileVideoPreview"
                    class="video-preview hidden"
                    controls
                  ></video>

                  <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ -->
                  <div id="noSourceMessage" class="text-muted">
                    <i class="fas fa-image fa-4x mb-3"></i>
                    <p>–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –≤—ã–±—Ä–∞–Ω</p>
                  </div>
                </div>

                <div
                  id="sourceInfo"
                  class="small text-muted mt-2 text-center"
                ></div>

                <!-- –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–ª—è –≤–∏–¥–µ–æ -->
                <div id="videoCaptureControls" class="text-center mt-3 hidden">
                  <button class="btn btn-primary" id="captureFrameBtn">
                    <i class="fas fa-camera me-2"></i>–°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                  </button>
                </div>
              </div>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ -->
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h6 class="mb-0">üîç –†–ï–ó–£–õ–¨–¢–ê–¢ –ê–ù–ê–õ–ò–ó–ê</h6>
              </div>
              <div class="card-body text-center">
                <img
                  id="resultImage"
                  class="result-image"
                  src=""
                  style="display: none"
                />
                <div id="resultPlaceholder" class="text-muted">
                  <i class="fas fa-search fa-4x mb-3"></i>
                  <p>–û–∂–∏–¥–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞</p>
                </div>
                <div id="analysisInfo" class="small text-muted mt-2"></div>
              </div>
            </div>

            <!-- –ü—Ä–æ—Ç–æ–∫–æ–ª –¥–µ—Ñ–µ–∫—Ç–æ–≤ -->
            <div class="card">
              <div class="card-header bg-light">
                <h6 class="mb-0">üìä –ü–†–û–¢–û–ö–û–õ –î–ï–§–ï–ö–¢–û–í</h6>
              </div>
              <div class="card-body">
                <div id="defectsTable">
                  <div class="text-center text-muted p-4">
                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                    <p>–ü—Ä–æ—Ç–æ–∫–æ–ª –±—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="row mt-3" id="actionPanel" style="display: none">
              <div class="col">
                <button class="btn btn-success">üì• –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª</button>
                <button class="btn btn-primary">üñ®Ô∏è –ü–µ—á–∞—Ç—å –æ—Ç—á–µ—Ç–∞</button>
                <button class="btn btn-info">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                <button class="btn btn-outline-secondary" id="newAnalysisBtn">
                  üóëÔ∏è –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = 'http://localhost:8000';
      // –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
      let currentMode = 'photo';
      let videoStream = null;
      let isAnalyzing = false;

      // –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      const photoModeBtn = document.getElementById('photoModeBtn');
      const videoModeBtn = document.getElementById('videoModeBtn');
      const photoUploadBlock = document.getElementById('photoUploadBlock');
      const videoUploadBlock = document.getElementById('videoUploadBlock');
      const staticImagePreview = document.getElementById('staticImagePreview');
      const liveVideoPreview = document.getElementById('liveVideoPreview');
      const fileVideoPreview = document.getElementById('fileVideoPreview');
      const noSourceMessage = document.getElementById('noSourceMessage');
      const sourceInfo = document.getElementById('sourceInfo');
      const videoCaptureControls = document.getElementById(
        'videoCaptureControls'
      );
      const captureFrameBtn = document.getElementById('captureFrameBtn');
      const startVideoBtn = document.getElementById('startVideoBtn');
      const stopVideoBtn = document.getElementById('stopVideoBtn');
      const analyzeBtn = document.getElementById('analyzeBtn');
      const analyzeBtnText = document.getElementById('analyzeBtnText');
      const newAnalysisBtn = document.getElementById('newAnalysisBtn');

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
      function updateDateTime() {
        const now = new Date();
        const options = {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        };
        document.getElementById('currentDateTime').textContent =
          now.toLocaleDateString('ru-RU', options);
      }
      setInterval(updateDateTime, 60000);
      updateDateTime();

      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
      document.getElementById('inspectionDate').valueAsDate = new Date();

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
      photoModeBtn.addEventListener('click', () => switchMode('photo'));
      videoModeBtn.addEventListener('click', () => switchMode('video'));

      function switchMode(mode) {
        currentMode = mode;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        photoModeBtn.classList.toggle('active', mode === 'photo');
        videoModeBtn.classList.toggle('active', mode === 'video');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫–∏ –≤–≤–æ–¥–∞
        photoUploadBlock.classList.toggle('hidden', mode !== 'photo');
        videoUploadBlock.classList.toggle('hidden', mode !== 'video');

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∞–Ω–∞–ª–∏–∑–∞
        analyzeBtnText.textContent =
          mode === 'photo'
            ? 'üöÄ –ó–ê–ì–†–£–ó–ò–¢–¨ –ò –ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨'
            : 'üéØ –ê–ù–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨ –¢–ï–ö–£–©–ò–ô –ö–ê–î–†';

        // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
        clearPreview();

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å –≤–∏–¥–µ–æ-—Ä–µ–∂–∏–º–∞
        if (mode !== 'video' && videoStream) {
          stopVideoStream();
        }
      }

      // –û—á–∏—Å—Ç–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
      function clearPreview() {
        staticImagePreview.classList.add('hidden');
        liveVideoPreview.classList.add('hidden');
        fileVideoPreview.classList.add('hidden');
        noSourceMessage.classList.remove('hidden');
        videoCaptureControls.classList.add('hidden');
        sourceInfo.textContent = '';

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞
        document.getElementById('resultImage').style.display = 'none';
        document.getElementById('resultPlaceholder').style.display = 'block';
        document.getElementById('analysisInfo').textContent = '';
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Ñ–æ—Ç–æ-—Ä–µ–∂–∏–º)
      document
        .getElementById('imageUpload')
        .addEventListener('change', function (e) {
          const file = e.target.files[0];
          if (file) {
            document.getElementById('fileName').textContent = file.name;

            const reader = new FileReader();
            reader.onload = function (e) {
              staticImagePreview.src = e.target.result;
              staticImagePreview.classList.remove('hidden');
              noSourceMessage.classList.add('hidden');
              fileVideoPreview.classList.add('hidden');
              liveVideoPreview.classList.add('hidden');

              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
              const image = new Image();
              image.onload = function () {
                sourceInfo.textContent = `–§–æ—Ç–æ ‚Ä¢ –†–∞–∑–º–µ—Ä: ${image.width}x${
                  image.height
                } ‚Ä¢ –§–æ—Ä–º–∞—Ç: ${file.type.split('/')[1].toUpperCase()}`;
              };
              image.src = e.target.result;
            };
            reader.readAsDataURL(file);
          }
        });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ—Ñ–∞–π–ª–∞
      document
        .getElementById('videoFileUpload')
        .addEventListener('change', function (e) {
          const file = e.target.files[0];
          if (file) {
            const url = URL.createObjectURL(file);
            fileVideoPreview.src = url;
            fileVideoPreview.classList.remove('hidden');
            liveVideoPreview.classList.add('hidden');
            staticImagePreview.classList.add('hidden');
            noSourceMessage.classList.add('hidden');
            videoCaptureControls.classList.remove('hidden');

            sourceInfo.textContent = `–í–∏–¥–µ–æ—Ñ–∞–π–ª ‚Ä¢ ${file.name} ‚Ä¢ ${(
              file.size /
              (1024 * 1024)
            ).toFixed(2)} MB`;
          }
        });

      // –ó–∞–ø—É—Å–∫ –≤–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã
      startVideoBtn.addEventListener('click', async () => {
        try {
          videoStream = await navigator.mediaDevices.getUserMedia({
            video: {
              width: { ideal: 1280 },
              height: { ideal: 720 },
              facingMode: { ideal: 'environment' }, // –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä—ã
            },
          });

          liveVideoPreview.srcObject = videoStream;
          liveVideoPreview.classList.remove('hidden');
          fileVideoPreview.classList.add('hidden');
          staticImagePreview.classList.add('hidden');
          noSourceMessage.classList.add('hidden');
          videoCaptureControls.classList.remove('hidden');

          startVideoBtn.classList.add('hidden');
          stopVideoBtn.classList.remove('hidden');

          sourceInfo.textContent = '–≠–Ω–¥–æ—Å–∫–æ–ø (–∂–∏–≤–æ–µ –≤–∏–¥–µ–æ) ‚Ä¢ 720p';
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', err);
          alert(
            '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —ç–Ω–¥–æ—Å–∫–æ–ø—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã.'
          );
        }
      });

      // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–µ–æ
      stopVideoBtn.addEventListener('click', () => {
        stopVideoStream();
      });

      function stopVideoStream() {
        if (videoStream) {
          videoStream.getTracks().forEach((track) => track.stop());
          videoStream = null;
        }
        liveVideoPreview.srcObject = null;
        liveVideoPreview.classList.add('hidden');
        startVideoBtn.classList.remove('hidden');
        stopVideoBtn.classList.add('hidden');
        videoCaptureControls.classList.add('hidden');
        noSourceMessage.classList.remove('hidden');
        sourceInfo.textContent = '';
      }

      // –°–Ω–∏–º–æ–∫ –∫–∞–¥—Ä–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–¥–ª—è –≤–∏–¥–µ–æ-—Ä–µ–∂–∏–º–∞)
      captureFrameBtn.addEventListener('click', () => {
        if (currentMode === 'video') {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –≤–∏–¥–µ–æ (–∂–∏–≤–æ–µ –∏–ª–∏ –∏–∑ —Ñ–∞–π–ª–∞)
          const videoElement = liveVideoPreview.classList.contains('hidden')
            ? fileVideoPreview
            : liveVideoPreview;

          if (videoElement.srcObject || videoElement.src) {
            captureAndAnalyzeFrame(videoElement);
          }
        }
      });

      // –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/–∫–∞–¥—Ä–∞
      analyzeBtn.addEventListener('click', async function () {
        if (currentMode === 'photo') {
          // –ê–Ω–∞–ª–∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ
          const imageData = staticImagePreview.src;
          if (!imageData || imageData === '') {
            alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!');
            return;
          }
          await analyzeImage(imageData);
        } else if (currentMode === 'video') {
          // –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞ –≤–∏–¥–µ–æ
          const videoElement = liveVideoPreview.classList.contains('hidden')
            ? fileVideoPreview
            : liveVideoPreview;

          if (!videoElement.srcObject && !videoElement.src) {
            alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤–∏–¥–µ–æ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª!');
            return;
          }
          captureAndAnalyzeFrame(videoElement);
        }
      });

      // –ó–∞—Ö–≤–∞—Ç –∏ –∞–Ω–∞–ª–∏–∑ –∫–∞–¥—Ä–∞ –∏–∑ –≤–∏–¥–µ–æ
      function captureAndAnalyzeFrame(videoElement) {
        const canvas = document.createElement('canvas');
        canvas.width = videoElement.videoWidth || videoElement.width;
        canvas.height = videoElement.videoHeight || videoElement.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

        const frameData = canvas.toDataURL('image/jpeg', 0.9);
        analyzeImage(frameData);
      }

      // –§—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      async function analyzeImage(imageData) {
        if (isAnalyzing) return;

        isAnalyzing = true;
        const spinner = document.getElementById('spinner');
        spinner.classList.remove('d-none');
        analyzeBtn.disabled = true;

        try {
          const engineNumber = document.getElementById('engineNumber').value;
          const bladeNumber = document.getElementById('bladeNumber').value;

          if (!engineNumber || !bladeNumber) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–≤–∏–≥–∞—Ç–µ–ª—è –∏ –ª–æ–ø–∞—Ç–∫–∏');
            return;
          }

          let response;

          if (currentMode === 'photo') {
            // –î–ª—è —Ñ–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
            const formData = new FormData();
            const blob = dataURLtoBlob(imageData);
            formData.append('file', blob, 'image.jpg');
            formData.append('engine_number', engineNumber);
            formData.append('blade_number', bladeNumber);

            response = await fetch(`${API_BASE_URL}/api/analyze-image`, {
              method: 'POST',
              body: formData,
            });
          } else {
            // –î–ª—è –≤–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º base64
            response = await fetch(`${API_BASE_URL}/api/analyze-frame`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                engine_number: engineNumber,
                blade_number: bladeNumber,
                image_data: imageData,
              }),
            });
          }

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
          updateUIWithResults(result);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:', error);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
        } finally {
          isAnalyzing = false;
          spinner.classList.add('d-none');
          analyzeBtn.disabled = false;
        }
      }

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ DataURL –≤ Blob
      function dataURLtoBlob(dataURL) {
        const parts = dataURL.split(';base64,');
        const contentType = parts[0].split(':')[1];
        const raw = window.atob(parts[1]);
        const uInt8Array = new Uint8Array(raw.length);

        for (let i = 0; i < raw.length; ++i) {
          uInt8Array[i] = raw.charCodeAt(i);
        }

        return new Blob([uInt8Array], { type: contentType });
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
      function updateUIWithResults(result) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞
        document.getElementById('resultImage').src = result.annotated_image;
        document.getElementById('resultImage').style.display = 'block';
        document.getElementById('resultPlaceholder').style.display = 'none';
        document.getElementById(
          'analysisInfo'
        ).textContent = `–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω ‚Ä¢ –ù–∞–π–¥–µ–Ω–æ –¥–µ—Ñ–µ–∫—Ç–æ–≤: ${result.defects_found} ‚Ä¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö: ${result.critical_defects}`;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('statsSection').style.display = 'flex';
        document.getElementById('actionPanel').style.display = 'block';
        document.getElementById('totalDefects').textContent =
          result.defects_found;
        document.getElementById('criticalDefects').textContent =
          result.critical_defects;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–µ—Ñ–µ–∫—Ç–æ–≤
        updateDefectsTable(result.defects);
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–µ—Ñ–µ–∫—Ç–æ–≤
      function updateDefectsTable(defects) {
        const defectsTable = document.getElementById('defectsTable');

        if (defects.length === 0) {
          defectsTable.innerHTML = `
                  <div class="text-center text-muted p-4">
                      <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                      <p>–î–µ—Ñ–µ–∫—Ç—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã</p>
                  </div>
              `;
          return;
        }

        let tableHTML = `
              <div class="table-responsive">
                <table class="table table-striped defect-table">
                    <thead>
                        <tr>
                            <th>–¢–∏–ø –¥–µ—Ñ–µ–∫—Ç–∞</th>
                            <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th>
                            <th>–†–∞–∑–º–µ—Ä</th>
                            <th>–£—Ä–æ–≤–µ–Ω—å –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏</th>
                            <th>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        defects.forEach((defect) => {
          const criticalityClass = getCriticalityClass(defect.criticality);
          const badgeClass = getBadgeClass(defect.criticality);

          tableHTML += `
              <tr class="${criticalityClass}">
                  <td><strong>${defect.type}</strong></td>
                  <td>x: ${Math.round(defect.coordinates.x)}, y: ${Math.round(
            defect.coordinates.y
          )}</td>
                  <td>${defect.size.toFixed(1)} –º–º</td>
                  <td><span class="badge ${badgeClass}">${
            defect.criticality
          }</span></td>
                  <td>
                      <div class="confidence-bar">
                          <div class="confidence-fill ${badgeClass}" style="width: ${Math.round(
            defect.confidence * 100
          )}%"></div>
                      </div>
                      <small>${Math.round(defect.confidence * 100)}%</small>
                  </td>
              </tr>
          `;
        });

        tableHTML += `</tbody></table></div>`;
        defectsTable.innerHTML = tableHTML;
      }

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å—Ç–∏–ª–µ–π
      function getCriticalityClass(criticality) {
        const classes = {
          –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π: 'defect-critical',
          –í—ã—Å–æ–∫–∏–π: 'defect-high',
          –°—Ä–µ–¥–Ω–∏–π: 'defect-medium',
          –ù–∏–∑–∫–∏–π: 'defect-low',
        };
        return classes[criticality] || '';
      }

      function getBadgeClass(criticality) {
        const classes = {
          –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π: 'bg-danger',
          –í—ã—Å–æ–∫–∏–π: 'bg-warning',
          –°—Ä–µ–¥–Ω–∏–π: 'bg-success',
          –ù–∏–∑–∫–∏–π: 'bg-info',
        };
        return classes[criticality] || 'bg-secondary';
      }

      // –ö–Ω–æ–ø–∫–∞ –Ω–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
      newAnalysisBtn.addEventListener('click', () => {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
        clearPreview();
        document.getElementById('statsSection').style.display = 'none';
        document.getElementById('actionPanel').style.display = 'none';
        document.getElementById('defectsTable').innerHTML = `
          <div class="text-center text-muted p-4">
            <i class="fas fa-clipboard-list fa-2x mb-2"></i>
            <p>–ü—Ä–æ—Ç–æ–∫–æ–ª –±—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞</p>
          </div>
        `;

        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
        document.getElementById('imageUpload').value = '';
        document.getElementById('videoFileUpload').value = '';
        document.getElementById('fileName').textContent = '';

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ
        if (videoStream) {
          stopVideoStream();
        }
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
      document.addEventListener('DOMContentLoaded', function () {
        const dropZone = document.querySelector('.image-container');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach((eventName) => {
          dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach((eventName) => {
          dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach((eventName) => {
          dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
          dropZone.style.borderColor = 'var(--accent)';
          dropZone.style.background = '#f0f8ff';
        }

        function unhighlight() {
          dropZone.style.borderColor = '#dee2e6';
          dropZone.style.background = '#fafafa';
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;

          if (files.length > 0) {
            if (currentMode === 'photo') {
              document.getElementById('imageUpload').files = files;
              const event = new Event('change');
              document.getElementById('imageUpload').dispatchEvent(event);
            } else {
              document.getElementById('videoFileUpload').files = files;
              const event = new Event('change');
              document.getElementById('videoFileUpload').dispatchEvent(event);
            }
          }
        }
      });
    </script>
  </body>
</html>
